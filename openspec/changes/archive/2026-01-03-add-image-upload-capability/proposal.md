# 提案:图片上传与存储功能

## 元数据

- **变更ID**: `add-image-upload-capability`
- **标题**: 图片上传与本地文件存储功能
- **状态**: proposed
- **创建时间**: 2026-01-03
- **负责人**: 待定

## 概述

为 EasyMall 系统添加图片上传和存储功能,支持商品图片(主图和详情图)和用户头像的上传、存储和访问。采用**本地文件存储**方案,图片存储在云服务器指定目录下,数据库存储完整 HTTP URL,前端通过 URL 直接访问图片。

## 背景与动机

### 当前问题

- 系统中的 `Product` 和 `User` 实体已包含图片字段(`image`/`images`/`avatar`),但缺少图片上传和存储功能
- 前端无法直接上传商品图片或用户头像
- 管理员添加商品时需要手动输入图片 URL,操作不便

### 业务需求

1. **商品图片管理**:支持上传商品主图和多张详情图
2. **用户头像**:支持用户上传和更换个人头像
3. **图片访问**:通过 HTTP URL 直接访问已上传的图片
4. **文件验证**:对上传图片的类型、大小进行限制

### 约束条件

- 存储规模:小规模(< 1GB)
- 部署环境:云服务器 (IP: 8.134.192.13)
- 技术栈:Spring Boot + 本地文件系统 + Nginx

## 影响范围

### 涉及模块

- **商品管理模块**:商品图片上传
- **用户管理模块**:用户头像上传
- **后台管理模块**:管理员上传商品图片
- **文件服务模块**:文件上传、存储、访问

### 数据库变更

无需修改数据库结构(图片字段已存在)。数据库存储**完整 HTTP URL**(非相对路径):
- `product.image`:商品主图 URL (如: `http://8.134.192.13/uploads/products/2024/01/uuid.jpg`)
- `product.images`:商品详情图列表,逗号分隔 (如: `url1,url2,url3`)
- `user.avatar`:用户头像 URL (如: `http://8.134.192.13/uploads/avatars/2024/01/uuid.jpg`)

**存储策略说明**:
- 图片**二进制文件**存储在服务器磁盘:`/data/easymall/uploads/`
- 数据库**只存储 URL 文本字符串**,不存储图片文件本身
- 前端直接使用数据库返回的 URL 访问图片

## 解决方案概述

### 技术方案

**本地文件存储 + Nginx 静态文件服务**

1. **存储目录结构**:
   ```
   /data/easymall/uploads/
   ├── products/           # 商品图片
   │   ├── 2024/01/       # 按年月组织
   │   └── ...
   └── avatars/           # 用户头像
       └── 2024/01/
   ```

2. **上传流程**:
   - 前端调用上传接口 POST `/api/upload/image`
   - 后端验证文件类型(仅允许 jpg/png/gif)和大小(≤ 5MB)
   - 生成唯一文件名(避免冲突):`UUID + 原始扩展名`
   - 保存文件到服务器磁盘:`/data/easymall/uploads/...`
   - 返回完整 HTTP URL: `http://8.134.192.13/uploads/products/2024/01/uuid.jpg`

3. **存储方式**:
   - **磁盘存储**:图片文件存储在云服务器 `/root/EasyMall/uploads/` 目录
   - **数据库存储**:存储完整 HTTP URL (非相对路径)
   - **前端访问**:直接使用 URL 显示图片

4. **访问映射**:
   - Nginx 配置:`/uploads/` → `/root/EasyMall/uploads/` (服务器实际路径)
   - 浏览器请求 `http://8.134.192.13/uploads/products/2024/01/uuid.jpg`
   - Nginx 映射到服务器磁盘文件并返回

5. **Docker 部署架构**:
   ```
   云服务器: /root/EasyMall/uploads/         ← 实际存储位置(持久化)
       ↓ (Docker Volume 挂载)
   容器内:   /data/easymall/uploads/         ← 应用访问路径
   ```
   - 图片存储在**云服务器磁盘**,而非容器内
   - 通过 Docker Volume 挂载到容器
   - 确保容器删除/重建后图片不丢失

### 架构设计

```
前端 → 上传接口 → Spring Boot 应用 → 保存到 /data/easymall/uploads/
                                           ↓
前端 ← 返回访问 URL ←               Nginx 静态文件服务
```

## 利益相关者

- **用户**:可以上传个人头像
- **管理员**:可以上传商品图片
- **系统**:获得完整的图片管理能力

## 风险与限制

### 风险

1. **存储空间**:云服务器磁盘空间有限,需定期清理无用图片
2. **多实例部署**:如果部署多个应用实例,需要共享存储目录
3. **备份**:图片文件需要纳入备份策略

### 限制

1. 文件大小限制:单个图片 ≤ 5MB
2. 文件类型限制:仅支持 jpg、jpeg、png、gif
3. 无图片压缩功能:直接存储原始文件

## 替代方案(已拒绝)

| 方案 | 优点 | 缺点 | 拒绝原因 |
|------|------|------|----------|
| 云服务商 OSS | 高可用、CDN 加速 | 需要额外费用、增加外部依赖 | 项目规模小,成本敏感 |
| MinIO 对象存储 | 自主控制、S3 兼容 | 需要额外部署和维护 | 增加复杂度,当前不需要 |

## 成功标准

1. 用户可以成功上传头像,并在个人中心显示
2. 管理员可以上传商品主图和详情图
3. 上传的图片可以通过 URL 直接访问
4. 对非法文件类型和大小进行正确拦截
5. 上传功能在云服务器 Docker 环境下正常工作

## 时间线

- **阶段 1**:核心上传功能(单图、头像)
- **阶段 2**:多图上传和管理
- **阶段 3**:图片删除和清理

## 相关规范

- 新增规范:`image-upload-and-storage`
- 影响规范:`admin-product-management`, `user-profile-management`

## 依赖关系

- 依赖现有:`Product`、`User` 实体
- 被依赖:可能被未来的"商品管理"、"用户中心"功能依赖

## 向后兼容性

- ✅ 完全向后兼容
- 仅添加新功能,不修改现有接口
- 现有图片 URL 字段保持不变
