## Context

优惠券系统是 EasyMall 商城的重要营销工具，需要与现有的会员等级系统、积分系统、订单系统深度集成。系统设计需要考虑：

1. **优惠券类型多样性** - 支持固定金额、百分比折扣、新人券、会员专属券等多种类型
2. **复杂的业务规则** - 使用门槛、有效期、数量限制、会员等级限制等
3. **高性能要求** - 优惠券查询是高频操作，需要合理使用缓存
4. **数据一致性** - 优惠券扣减、订单取消返还等场景需要保证事务一致性
5. **与现有系统集成** - 订单系统、积分系统、会员系统

## Goals / Non-Goals

### Goals
- 提供完整的优惠券管理功能（模板、领取、使用、管理）
- 支持多种优惠券类型和灵活的业务规则配置
- 与订单系统无缝集成，支持自动计算优惠金额
- 支持积分兑换优惠券
- 提供后台管理功能和数据统计
- 使用 Redis 缓存提升查询性能

### Non-Goals
- 不支持优惠券转赠功能（优惠券仅限本人使用）
- 不支持优惠券分享到社交媒体
- 不支持复杂的组合优惠券（如多张券叠加使用）
- 不支持优惠券的分期发放（如每月发放一张）

## Decisions

### 1. 优惠券类型设计

**Decision**: 使用 `CouponType` 枚举区分优惠券类型，每种类型有独立的计算逻辑。

**类型定义**:
- `FIXED_AMOUNT` - 固定金额券（满100减10）
- `PERCENTAGE` - 百分比折扣券（8.5折）
- `NEWCOMER` - 新人专享券
- `MEMBER_EXCLUSIVE` - 会员专属券

**Reasoning**: 清晰的类型划分便于后续扩展，也便于前端展示不同的优惠券样式。

**Alternatives considered**:
- 使用单一表通过字段区分（选型：当前方案更清晰）
- 使用继承设计不同的优惠券类（过于复杂，不需要）

### 2. 数据库表设计

**Decision**: 三表设计分离模板和用户优惠券。

**表结构**:
1. `coupon_template` - 优惠券模板表
   - 存储优惠券的通用配置（类型、优惠值、门槛、有效期、发行数量等）
   - 管理员可以创建和编辑

2. `user_coupon` - 用户优惠券表
   - 存储用户领取的优惠券实例
   - 关联模板ID，记录状态（未使用、已使用、已过期）
   - 记录使用时间、订单号

3. `coupon_usage_log` - 优惠券使用记录表
   - 记录优惠券的完整使用历史
   - 支持数据统计和审计

**Reasoning**: 三表分离设计清晰，模板与实例分离便于管理，记录表支持统计分析。

### 3. 优惠券状态机

**Decision**: 用户优惠券使用状态机管理。

**状态定义**:
- `UNUSED` (0) - 未使用
- `USED` (1) - 已使用
- `EXPIRED` (2) - 已过期

**状态流转**:
```
UNUSED -> USED (用户使用优惠券创建订单)
USED -> UNUSED (订单取消，返还优惠券)
UNUSED -> EXPIRED (定时任务批量更新过期状态)
```

**Reasoning**: 清晰的状态流转确保业务逻辑正确，订单取消时返还优惠券保证用户体验。

### 4. 优惠券计算逻辑

**Decision**: 在订单服务中注入优惠券服务，计算优惠金额。

**计算流程**:
1. 用户选择优惠券时，前端调用 `POST /api/coupon/calculate` 预计算优惠金额
2. 创建订单时，后端重新验证优惠券有效性并计算优惠金额
3. 优惠金额直接从订单总额中扣除

**验证规则**:
- 优惠券状态为未使用
- 当前时间在有效期内
- 订单金额满足使用门槛
- 用户会员等级满足要求（如为会员专属券）

**Reasoning**: 前后端双重验证确保数据安全，服务分离保持代码清晰。

### 5. 积分兑换优惠券实现

**Decision**: 扩展现有的积分兑换系统，新增优惠券类型的兑换商品。

**实现方式**:
1. 在 `points_product` 表中新增 `product_type` 字段区分商品类型
   - `PRODUCT` - 实物商品
   - `COUPON` - 优惠券
2. 新增 `relation_id` 字段关联优惠券模板ID
3. 兑换时调用优惠券服务发放优惠券

**Reasoning**: 复用现有积分兑换系统，减少代码重复，统一兑换体验。

### 6. 缓存策略

**Decision**: 使用 Redis 缓存上架中的优惠券模板和用户可用优惠券列表。

**缓存设计**:
- `coupon:template:{templateId}` - 优惠券模板详情
- `coupon:template:active` - 上架中的优惠券模板列表
- `coupon:user:{userId}:available` - 用户可用优惠券列表

**缓存失效策略**:
- 优惠券模板修改/下架时清除对应缓存
- 用户领取/使用优惠券时清除用户列表缓存
- 设置合理的 TTL（如5分钟）

**Reasoning**: 缓存热门数据减少数据库查询，提升系统性能。

### 7. Spring Boot 4.0.1 特性应用

**Decision**: 利用 Spring Boot 4.0.1 的新特性优化优惠券系统。

**应用特性**:
1. **Virtual Threads (虚拟线程)** - 用于优惠券过期检查定时任务
2. **Observability (可观测性)** - 添加 Micrometer 指标监控优惠券使用情况
3. **Jakarta EE** - 使用 `jakarta.*` 命名空间（项目已升级）
4. **Improved Validation** - 使用 `@Validated` 和自定义验证注解

**Reasoning**: 利用新特性提升系统性能和可维护性。

### 8. 事务管理

**Decision**: 关键操作使用事务确保数据一致性。

**事务场景**:
1. 领取优惠券 - 检查数量限制 + 扣减发行数量 + 创建用户优惠券
2. 使用优惠券创建订单 - 扣减优惠券 + 创建订单
3. 取消订单返还优惠券 - 更新优惠券状态 + 清除使用记录
4. 积分兑换优惠券 - 扣减积分 + 发放优惠券

**Reasoning**: 事务保证数据一致性，避免并发问题。

## Risks / Trade-offs

### Risk 1: 优惠券并发领取导致超发

**Risk**: 高并发场景下，多个用户同时领取最后一张优惠券可能导致超发。

**Mitigation**:
1. 使用数据库乐观锁（version 字段）控制发行数量
2. 使用 Redis 分布式锁控制领取操作
3. 领取操作加事务隔离级别

### Risk 2: 优惠券计算性能问题

**Risk**: 大量优惠券时，计算可用优惠券列表可能较慢。

**Mitigation**:
1. 使用 Redis 缓存可用优惠券列表
2. 限制单次查询返回数量（分页）
3. 异步预计算用户可用优惠券

### Risk 3: 订单取消时优惠券返还逻辑复杂

**Risk**: 订单可能处于不同状态，返还优惠券需要考虑多种场景。

**Mitigation**:
1. 明确只有待支付订单取消时才返还优惠券
2. 已支付订单取消不返还优惠券（需客服处理）
3. 使用状态机管理订单状态，确保返还逻辑正确

### Trade-off 1: 优惠券转赠功能

**Trade-off**: 当前设计不支持优惠券转赠，限制了社交传播效果。

**Rationale**: 优惠券转赠增加了系统复杂度，需要考虑转赠记录、使用权限等问题。作为课程实训项目，优先实现核心功能。

### Trade-off 2: 定时任务 vs 实时更新

**Trade-off**: 优惠券过期状态使用定时任务批量更新，而非实时检查。

**Rationale**: 实时检查每次查询都需要判断有效期，性能开销大。定时任务每5分钟批量更新一次，误差可接受。

## Migration Plan

### Phase 1: 数据库迁移
1. 创建新表（`V5__Add_coupon_tables.sql`）
2. 初始化测试数据（优惠券模板）

### Phase 2: 核心功能实现
1. 实体类、Mapper、Service、Controller
2. 优惠券领取、查询、使用功能

### Phase 3: 集成现有系统
1. 修改订单服务支持优惠券
2. 扩展积分兑换系统
3. 会员升级自动发放优惠券

### Phase 4: 后台管理
1. 管理员优惠券管理接口
2. 数据统计功能

### Phase 5: 测试与优化
1. 单元测试
2. 集成测试
3. 性能优化（缓存）

### Rollback Plan
- 如需回滚，删除 `coupon_*` 相关表即可
- 订单系统需要保留兼容，未使用优惠券时正常运行

## Open Questions

1. **优惠券有效期设置方式**
   - Question: 是否支持相对有效期（如领取后7天有效）？
   - **Resolution**: 第一版仅支持绝对有效期（指定开始和结束时间），后续可扩展相对有效期。

2. **优惠券与会员折扣叠加规则**
   - Question: 优惠券是否可以与会员折扣叠加使用？
   - **Resolution**: 第一版不支持叠加，优惠券在会员折扣后的金额基础上计算。

3. **优惠券使用数量限制**
   - Question: 一张订单是否可以使用多张优惠券？
   - **Resolution**: 第一版限制每笔订单只能使用一张优惠券。

4. **过期优惠券处理**
   - Question: 过期优惠券是否保留记录供用户查看？
   - **Resolution**: 保留记录，用户可在"已过期"标签查看历史优惠券。
